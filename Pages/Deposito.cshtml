@page
@model DepositoModel
@{
    ViewData["Title"] = "Novo Depósito";
}
<div class="form-section">
    <div class="form-box">
        <h2>Realizar Depósito</h2>
        <form method="post" id="depositoForm" onsubmit="return validarAgendamento()">
            @Html.AntiForgeryToken()

            <label asp-for="Deposito.Valor">Valor:</label>
            <div class="input-prefix">
                <span class="prefix">R$</span>
                <input asp-for="Deposito.Valor" type="number" step="0.01" required />
            </div>

            <label asp-for="Deposito.Descricao">Descrição:</label>
            <input asp-for="Deposito.Descricao" type="text" />

            <label>Agendar para outro dia?</label>
            <input type="checkbox" id="agendar" onchange="toggleAgendamento()" />

            <div id="agendamentoCampos" style="display:none;">
                <label asp-for="Deposito.DiaDepositoAgendado">Dia:</label>
                <select asp-for="Deposito.DiaDepositoAgendado" id="DiaDepositoAgendado">
                    <option value="">Selecione um dia</option>
                </select>

                <label asp-for="Deposito.MesDepositoAgendado">Mês:</label>
                <select asp-for="Deposito.MesDepositoAgendado" id="MesDepositoAgendado" asp-items="Model.ListaMeses" onchange="atualizarDias()">
                    <option value="">Selecione um mês</option>
                </select>

                <label asp-for="Deposito.AnoDepositoAgendado">Ano:</label>
                <select asp-for="Deposito.AnoDepositoAgendado" id="AnoDepositoAgendado" onchange="atualizarDias()">
                    <option value="">Selecione um ano</option>
                    @for (int i = DateTime.Now.Year; i <= DateTime.Now.Year + 10; i++)
                    {
                        <option value="@i">@i</option>
                    }
                </select>
            </div>

            <div id="mensagemErro" style="color: red; display: none; margin-top: 10px;"></div>

            <button type="submit">Confirmar Depósito</button>
        </form>
    </div>
</div>

<script>
    function toggleAgendamento() {
        const checkbox = document.getElementById("agendar");
        const campos = document.getElementById("agendamentoCampos");
        const mensagemErro = document.getElementById("mensagemErro");
        campos.style.display = checkbox.checked ? "block" : "none";
        mensagemErro.style.display = "none"; // Esconde a mensagem quando desmarca o checkbox
    }

    function diasNoMes(mes, ano) {
        if (!mes || !ano) return 31; // Default to 31 if month or year isn't selected
        return new Date(ano, mes, 0).getDate();
    }

    function atualizarDias() {
        const mesSelect = document.getElementById("MesDepositoAgendado");
        const anoSelect = document.getElementById("AnoDepositoAgendado");
        const diaSelect = document.getElementById("DiaDepositoAgendado");
        const mensagemErro = document.getElementById("mensagemErro");

        const mes = parseInt(mesSelect.value);
        const ano = parseInt(anoSelect.value);

        diaSelect.innerHTML = "<option value=''>Selecione um mês/ano</option>";
        if (!mes || !ano) return; // Don't populate days if month or year isn't selected

        const dias = diasNoMes(mes, ano);
        for (let i = 1; i <= dias; i++) {
            const option = document.createElement("option");
            option.value = i;
            option.textContent = i;
            diaSelect.appendChild(option);
        }
        mensagemErro.style.display = "none"; // Esconde a mensagem ao atualizar os dias
    }

    function validarAgendamento() {
        const checkbox = document.getElementById("agendar");
        const diaSelect = document.getElementById("DiaDepositoAgendado");
        const mesSelect = document.getElementById("MesDepositoAgendado");
        const anoSelect = document.getElementById("AnoDepositoAgendado");
        const mensagemErro = document.getElementById("mensagemErro");

        if (checkbox.checked) {
            if (!diaSelect.value || !mesSelect.value || !anoSelect.value) {
                mensagemErro.textContent = "Por favor, selecione dia, mês e ano para o depósito agendado.";
                mensagemErro.style.display = "block";
                return false; // Impede o envio do formulário
            }
        }
        mensagemErro.style.display = "none";
        return true; // Permite o envio do formulário
    }

    window.onload = function () {
        if (document.getElementById("MesDepositoAgendado").value && document.getElementById("AnoDepositoAgendado").value) {
            atualizarDias();
        }
    };
</script>