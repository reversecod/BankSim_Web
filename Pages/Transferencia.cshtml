@page
@model TransferenciaModel
@{
    ViewData["Title"] = "Nova Transferência";
}
<div class="form-section">
    <div class="form-box">
        <h2>Realizar Transferência</h2>
        <form method="post">
            @Html.AntiForgeryToken()

            <label asp-for="Transferencia.Valor">Valor:</label>
            <div class="input-prefix">
                <span class="prefix">R$</span>
                <input asp-for="Transferencia.Valor" type="number" step="0.01" required />
            </div>

            <label asp-for="Transferencia.TipoTransferencia">Tipo de Transferência:</label>
            <select asp-for="Transferencia.TipoTransferencia" id="tipoTransferencia" onchange="toggleJuros()">
                <option value="D">Débito (Saldo)</option>
                <option value="C">Crédito (Limite)</option>
            </select>

            <div id="jurosCampos" style="display:none;">
                <label>Adicionar Juros?</label>
                <input type="checkbox" id="jurosCheckbox" onchange="toggleJurosDetalhes()" />

                <div id="jurosDetalhes" style="display:none; margin-top: 10px;">
                    <label asp-for="Transferencia.TipoJuros">Tipo de Juros:</label>
                    <select asp-for="Transferencia.TipoJuros">
                        <option value="S">Simples</option>
                        <option value="C">Composto</option>
                    </select>

                    <label asp-for="Transferencia.ValorPorcentagem">Percentual de Juros (%):</label>
                    <input asp-for="Transferencia.ValorPorcentagem" type="number" step="0.01" min="0" />
                </div>
            </div>

            <label>Agendar para outro dia?</label>
            <input type="checkbox" id="agendar" onchange="toggleAgendamento()" />

            <div id="agendamentoCampos" style="display:none;">
                <label asp-for="Transferencia.DiaTransferenciaAgendada">Dia:</label>
                <select asp-for="Transferencia.DiaTransferenciaAgendada" id="DiaTransferenciaAgendada">
                    <option value="">Selecione um dia</option>
                </select>

                <label asp-for="Transferencia.MesTransferenciaAgendada">Mês:</label>
                <select asp-for="Transferencia.MesTransferenciaAgendada" id="MesTransferenciaAgendada" asp-items="Model.ListaMeses" onchange="atualizarDias()">
                    <option value="">Selecione um mês</option>
                </select>

                <label asp-for="Transferencia.AnoTransferenciaAgendada">Ano:</label>
                <select asp-for="Transferencia.AnoTransferenciaAgendada" id="AnoTransferenciaAgendada" onchange="atualizarDias()">
                    <option value="">Selecione um ano</option>
                    @for (int i = DateTime.Now.Year; i <= DateTime.Now.Year + 10; i++)
                    {
                        <option value="@i">@i</option>
                    }
                </select>
            </div>

            <div id="mensagemErro" style="color: red; display: none; margin-top: 10px;"></div>

            <button type="submit">Confirmar Transferência</button>
        </form>
    </div>
</div>

<script>
    function toggleJuros() {
        const tipoTransferencia = document.getElementById("tipoTransferencia").value;
        const jurosCampos = document.getElementById("jurosCampos");
        jurosCampos.style.display = tipoTransferencia === "C" ? "block" : "none";
        if (tipoTransferencia !== "C") {
            document.getElementById("jurosCheckbox").checked = false;
            toggleJurosDetalhes();
        }
    }

    function toggleJurosDetalhes() {
        const checkbox = document.getElementById("jurosCheckbox");
        const detalhes = document.getElementById("jurosDetalhes");
        detalhes.style.display = checkbox.checked ? "block" : "none";
    }

    function toggleAgendamento() {
        const checkbox = document.getElementById("agendar");
        const campos = document.getElementById("agendamentoCampos");
        const mensagemErro = document.getElementById("mensagemErro");
        campos.style.display = checkbox.checked ? "block" : "none";
        mensagemErro.style.display = "none";
    }

    function diasNoMes(mes, ano) {
        if (!mes || !ano) return 31;
        return new Date(ano, mes, 0).getDate();
    }

    function atualizarDias() {
        const mesSelect = document.getElementById("MesTransferenciaAgendada");
        const anoSelect = document.getElementById("AnoTransferenciaAgendada");
        const diaSelect = document.getElementById("DiaTransferenciaAgendada");
        const mensagemErro = document.getElementById("mensagemErro");

        const mes = parseInt(mesSelect.value);
        const ano = parseInt(anoSelect.value);

        diaSelect.innerHTML = "<option value=''>Selecione um dia</option>";
        if (!mes || !ano) return;

        const dias = diasNoMes(mes, ano);
        for (let i = 1; i <= dias; i++) {
            const option = document.createElement("option");
            option.value = i;
            option.textContent = i;
            diaSelect.appendChild(option);
        }
        mensagemErro.style.display = "none";
    }

    function validarAgendamento() {
        const checkbox = document.getElementById("agendar");
        const diaSelect = document.getElementById("DiaTransferenciaAgendada");
        const mesSelect = document.getElementById("MesTransferenciaAgendada");
        const anoSelect = document.getElementById("AnoTransferenciaAgendada");
        const mensagemErro = document.getElementById("mensagemErro");

        if (checkbox.checked) {
            if (!diaSelect.value || !mesSelect.value || !anoSelect.value) {
                mensagemErro.textContent = "Por favor, selecione dia, mês e ano para a transferência agendada.";
                mensagemErro.style.display = "block";
                return false;
            }
        }
        return true;
    }

    window.onload = function () {
        if (document.getElementById("MesTransferenciaAgendada").value && document.getElementById("AnoTransferenciaAgendada").value) {
            atualizarDias();
        }
        toggleJuros(); // Inicializa a exibição dos campos de juros
    };
</script>